{% extends 'base.html.twig' %}

{% block title %}Accueil{% endblock %}

{% block stylesheets %}
<style>
:root{
  --bg-primary:#2B2D31; --bg-media:#1E1F22; --line:#3F4147;
  --text:#DBDEE1; --muted:#B5BAC1;
  --sort-btn-w: 180px;
}

/* libellé à gauche de la dropdown */
.jk-sortbar{ justify-content:flex-start; }

/* bouton : texte aligné à gauche, caret forcé à droite, pas d'effet click/focus */
.jk-sort-toggle{
  width: var(--sort-btn-w);
  background: var(--bg-primary);
  color: var(--text);
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: .45rem 2rem .45rem .75rem;
  font-weight: 600;
  text-align: left;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}
.jk-sort-toggle::after{
  filter: invert(1) opacity(.8);
  position: absolute;
  right: .6rem; top: 50%; transform: translateY(-50%);
  margin-left: 0 !important;
}
.jk-sort-toggle:hover,
.jk-sort-toggle:active{
  background: var(--bg-primary);
  color: var(--text);
  border-color: var(--line);
  box-shadow: none !important;
  outline: none !important;
}
.jk-sort-toggle:focus,
.jk-sort-toggle:focus-visible{
  outline: none !important;
  box-shadow: none !important;
  background: var(--bg-primary);
  color: var(--text);
  border-color: var(--line);
}

/* menu */
.jk-menu{
  background: var(--bg-primary);
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: .5rem;
  min-width: var(--sort-btn-w);
}
.jk-menu .dropdown-item{
  color: var(--text);
  border-radius: 6px;
  padding: .55rem .75rem;
  display:flex; justify-content:space-between; align-items:center;
  transition: background-color 0.2s ease;
}
.jk-menu .dropdown-item:hover{
  background:#29292d;
  color: var(--text);
}
.jk-menu .dropdown-item:active,
.jk-menu .dropdown-item:focus{
  background:#29292d;
  color: var(--text);
  outline:none !important;
  box-shadow:none !important;
}

/* icône de l'option sélectionnée */
.jk-check{ 
  color: var(--muted); 
  margin-left: 8px; /* Espace entre le nom et l'icône */
}
</style>
{% endblock %}

{% block body %}
{# Titre dynamique basé sur la catégorie #}
{% set currentCategoryId = app.request.query.get('category') %}
{% set currentCategoryName = null %}
{% if currentCategoryId %}
  {% for category in categories %}
    {% if category.id == currentCategoryId|number_format(0, '', '') %}
      {% set currentCategoryName = category.name|capitalize %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if currentCategoryName %}
  <h1 class="mb-4 text-white">Blagues {{ currentCategoryName }} ({{ jokes|length }})</h1>
{% else %}
  <h1 class="mb-4 text-white">Toutes les blagues ({{ jokes|length }})</h1>
{% endif %}

{# SORT BAR #}
{% set q = app.request.query.all %}
{% set currentSort = q.sort ?? 'newest' %}
{% set sortLabel = {
  'price_asc': 'Prix : Croissant',
  'price_desc': 'Prix : Décroissant',
  'newest': 'Nouveau'
}[currentSort] ?? 'Nouveau' %}
{% set route = app.request.attributes.get('_route') %}

<div class="d-flex justify-content-end align-items-center mb-4">
  <div class="d-flex align-items-center gap-2">
    <span class="jk-sort-label">Trier par</span>

    <div class="dropdown">
      <button
        class="btn jk-sort-toggle dropdown-toggle"
        type="button"
        id="sortDropdown"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-expanded="false">
        <span class="jk-sort-text">{{ sortLabel }}</span>
      </button>

      <ul class="dropdown-menu jk-menu" aria-labelledby="sortDropdown">
        <li>
          <a class="dropdown-item d-flex justify-content-between align-items-center {% if currentSort == 'price_asc' %}is-active{% endif %}"
             href="{{ path(route, q|merge({'sort':'price_asc','page':1})) }}">
            <span>Prix : Croissant</span>
            {% if currentSort == 'price_asc' %}<i class="fa-solid fa-check jk-check"></i>{% endif %}
          </a>
        </li>
        <li>
          <a class="dropdown-item d-flex justify-content-between align-items-center {% if currentSort == 'price_desc' %}is-active{% endif %}"
             href="{{ path(route, q|merge({'sort':'price_desc','page':1})) }}">
            <span>Prix : Décroissant</span>
            {% if currentSort == 'price_desc' %}<i class="fa-solid fa-check jk-check"></i>{% endif %}
          </a>
        </li>
        <li>
          <a class="dropdown-item d-flex justify-content-between align-items-center {% if currentSort == 'newest' %}is-active{% endif %}"
             href="{{ path(route, q|merge({'sort':'newest','page':1})) }}">
            <span>Nouveau</span>
            {% if currentSort == 'newest' %}<i class="fa-solid fa-check jk-check"></i>{% endif %}
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="cards-grid">
  {% for joke in jokes %}
    <div class="card card-bundle">
      <div class="bundle-media">
        {% if joke.photo %}
          <img src="{{ asset('uploads/jokes/' ~ joke.photo) }}" alt="{{ joke.title }}">
        {% else %}
          <img src="{{ asset('images/placeholder.jpg') }}" alt="Placeholder">
        {% endif %}
      </div>
      <div class="bundle-body">
        <h5 class="bundle-title">{{ joke.title }}</h5>
        <div class="bundle-action-slot">
          <span class="bundle-price">€{{ joke.price|number_format(2, ',', ' ') }}</span>
          <a href="{{ path('shop_detail', {id: joke.id}) }}"
             class="bundle-cta"
             aria-label="Acheter pour {{ joke.price|number_format(2, ',', ' ') }} euros">
             Acheter pour €{{ joke.price|number_format(2, ',', ' ') }}
          </a>
        </div>
      </div>
    </div>
  {% else %}
    <div class="text-muted py-5">
      Aucune blague trouvée.
    </div>
  {% endfor %}
</div>
{% endblock %}
